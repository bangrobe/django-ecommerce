{% extends 'base.html' %}
{% load static %}

{% block title %}
Payment page
{% endblock title %}

{% block content %}
<div class="container-fluid pt-5">
    <div class="row px-xl-5">
        <div class="col-lg-8 table-responsive mb-5">
            <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Billing Address</h5>
                  <p class="card-text mb-0">{{ order.full_name}}  </p>
                  <p class="card-text mb-0">{{ order.full_address}}  </p>
                  <p class="card-text mb-0">{{ order.city }}, {{ order.state}} </p>
                  <p class="card-text mb-0">{{ order.country}}</p>
                  <p class="card-text mb-0">{{ order.email}}</p>
                  <p class="card-text mb-0">{{ order.phone}}</p>
                  {% if order.order_note %}
                    <b>Order Note:</b> {{ order.order_note }}
                  {% endif %}
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Payment Method</h5>
                  <p class="card-text">Paypal</p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Review Product</h5>
                  <table class="table table-bordered text-center mb-0">
                    <thead class="bg-secondary text-dark">
                        <tr>
                            <th>Products</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody class="align-middle">
                        {% for cart_item in cart_items  %}
                        <tr>
                            <td class="align-middle">
                                <a href="{{ cart_item.product.get_url }}">
                                <img src="{{ cart_item.product.images.url }}" alt="" style="width: 50px;"> {{ cart_item.product.product_name }} </a>
                                 <p class="text-muted small">
                                    {% if cart_item.variation.all  %}
                                        {% for item in cart_item.variation.all %}
                                            {{ item.variation_category | capfirst }}: {{ item.variation_value | capfirst }} <br />
                                        {% endfor %}
                                    {% endif %}
                                 </p>
                            </td>
                            <td class="align-middle">${{ cart_item.product.price }}</td>
                            <td class="align-middle">
                                <div class="input-group quantity mx-auto" style="width: 100px;">
                                    <input disabled type="text" class="form-control form-control-sm bg-secondary text-center" value="{{ cart_item.quantity }}">
                                </div>
                            </td>
                            <td class="align-middle">$ {{ cart_item.sub_total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-secondary mb-5">
                <div class="card-header bg-secondary border-0">
                    <h4 class="font-weight-semi-bold m-0">Order Summary</h4>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3 pt-1">
                        <h6 class="font-weight-medium">Subtotal</h6>
                        <h6 class="font-weight-medium">${{ total }}</h6>
                    </div>
                    <div class="d-flex justify-content-between">
                        <h6 class="font-weight-medium">Tax</h6>
                        <h6 class="font-weight-medium">${{tax}}</h6>
                    </div>
                </div>
                <div class="card-footer border-secondary bg-transparent">
                    <div class="d-flex justify-content-between mt-2">
                        <h5 class="font-weight-bold">Total</h5>
                        <h5 class="font-weight-bold">${{ grand_total }}</h5>
                    </div>
                    <div id="paypal-button-container">
                        <!--PAYPAL BUTTON-->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block scripts %}
 <script src="https://www.paypal.com/sdk/js?client-id=Ab8I2jQCKHW5p_Yo9EWHuwZhzsgNkTrIKh_4lMoT2rMRkEbKMLfyJjxL2wAcMPi7-JUZ9oUqq0ad0A3t&currency=USD"></script>
 <script>
    var amount = "{{ grand_total }}"
    var url = "{% url 'payment' %}"
    var redirect_url = "{% url 'order-complete' %}"
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    var orderID = "{{ order.order_number }}"
    var payment_method = 'PayPal'
    paypal.Buttons({
      // Sets up the transaction when a payment button is clicked
      createOrder: (data, actions) => {
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: amount // Can also reference a variable or function
            }
          }]
        });
      },
      // Finalize the transaction after payer approval
      onApprove: (data, actions) => {
        return actions.order.capture().then(function(orderData) {
          // Successful capture! For dev/demo purposes:
          console.log('Capture result', orderData);
          function sendData() { 
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    orderID: orderID,
                    transID: orderData.id,
                    payment_method: payment_method,
                    status: orderData.status,
                }),
              })
              .then((response)=> response.json())
              .then((data)=> {
                console.log('Success: ', data);
                window.location.href = redirect_url + '?order_number=' + data.order_number + '&payment_id=' + data.transID;
              })
          }
          sendData();
          // When ready to go live, remove the alert and show a success message within this page. For example:
          // const element = document.getElementById('paypal-button-container');
          // element.innerHTML = '<h3>Thank you for your payment!</h3>';
          // Or go to another URL:  actions.redirect('thank_you.html');
        });
      }
    }).render('#paypal-button-container');
  </script>
{% endblock scripts %}



